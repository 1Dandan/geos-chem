!------------------------------------------------------------------------------
!                  GEOS-Chem Global Chemical Transport Model                  !
!------------------------------------------------------------------------------
!BOP
!
! !MODULE: taggeddiaglist_mod.F90
!
! !DESCRIPTION:
!
! !INTERFACE:
!
MODULE TaggedDiagList_Mod
!
! !USES:
!
  USE DiagList_Mod
  USE ErrCode_Mod
  USE Precision_Mod

  IMPLICIT NONE
  PRIVATE
!
! !PUBLIC MEMBER FUNCTIONS:
!
  PUBLIC  :: Init_TaggedDiagList
  PUBLIC  :: Print_TaggedDiagList
  PUBLIC  :: Query_TaggedDiagList
  PUBLIC  :: Query_Tag_in_TagList
  PUBLIC  :: Cleanup_TaggedDiagList
!
! !PRIVATE MEMBER FUNCTIONS
!
  PRIVATE :: Init_TaggedDiagItem
  PRIVATE :: InsertBeginning_TaggedDiagList
  PRIVATE :: Update_TaggedDiagList
  PRIVATE :: Init_TagItem
  PRIVATE :: InsertBeginning_TagList
  PRIVATE :: Print_TagList
  PRIVATE :: Cleanup_TagList
!
! !PUBLIC DATA TYPES:
!
  !=========================================================================
  ! Derived type for tagged diagnostic items, e.g. DryDep
  !=========================================================================
  TYPE, PUBLIC :: TaggedDgnItem
     CHARACTER(LEN=63)              :: metadataID
     LOGICAL                        :: isWildcard
     TYPE(TagList),       POINTER   :: tagList
     TYPE(TagList),       POINTER   :: wildcardList
     TYPE(TaggedDgnItem), POINTER   :: next
  END TYPE TaggedDgnItem

  !=========================================================================
  ! Derived type for tagged diagnostic list, e.g. DryDep, SpeciesConc, etc
  !=========================================================================
  TYPE, PUBLIC :: TaggedDgnList
     TYPE(TaggedDgnItem), POINTER  :: head
  END TYPE TaggedDgnList

  !=========================================================================
  ! Derived type for tag items (can be used for any linked list of strings)
  !=========================================================================
  TYPE, PUBLIC :: TagItem
     CHARACTER(LEN=63)      :: name
     TYPE(TagItem), POINTER :: next
  END TYPE TagItem

  !=========================================================================
  ! Derived type for tag list (can be used for any linked list of strings)
  !=========================================================================
  TYPE, PUBLIC :: TagList
     INTEGER                 :: count
     TYPE(TagItem), POINTER  :: head
  END TYPE TagList
!
! !REVISION HISTORY:
!  18 Nov 2019 - E. Lundgren - Initial version
!  See gitk browser for rest of revision history
!EOP
!------------------------------------------------------------------------------
!BOC
CONTAINS
!EOC
!------------------------------------------------------------------------------
!                  GEOS-Chem Global Chemical Transport Model                  !
!------------------------------------------------------------------------------
!BOP
!
! !IROUTINE: Init_TaggedDiagList
!
! !DESCRIPTION:
!\\
!\\
! !INTERFACE:
!
  SUBROUTINE Init_TaggedDiagList ( am_I_Root, DiagList, TaggedDiagList, RC )
!
! !USES:
!
!
! !INPUT PARAMETERS:
!
    LOGICAL,              INTENT(IN)    :: am_I_Root
    TYPE(DgnList),        INTENT(IN)    :: DiagList
!
! !INPUT AND OUTPUT PARAMETERS:
!
    TYPE(TaggedDgnList),  INTENT(INOUT) :: TaggedDiagList
!
! !OUTPUT PARAMETERS:
!
    INTEGER,              INTENT(OUT)   :: RC
!
! !REVISION HISTORY:
!  18 Nov 2019 - E. Lundgren - initial version
!  See gitk browser for rest of revision history
!EOP
!------------------------------------------------------------------------------
!BOC
!
! !LOCAL VARIABLES:
!
    LOGICAL                       :: FOUND
    TYPE(TaggedDiagItem), POINTER :: NewTaggedDiagItem

    !=======================================================================
    ! Init_TaggedDiagList begins here
    !=======================================================================

    ! Initialize list of tagged diagnostics
    TaggedDiagList%head => NULL()

    ! Loop over all diagnostics listed in diagnostics config file
    current => DiagList%head
    DO WHILE ( ASSOCIATED( current ) )
       IF ( current%state == 'DIAG' .AND. current%isTagged ) THEN
          CALL Query_TaggedDiagList( am_I_Root, TaggedDiagList, &
                                     name=current%metadataID,   &
                                     FOUND=FOUND,               &
                                     RC=RCRC)
          IF ( FOUND ) THEN
             CALL Update_TaggedDiagList( am_I_Root, TaggedDiagList, &
                                         metadataID, isWildcard, tag, RC)
          ELSE
             CALL Init_TaggedDiagItem( am_I_Root,                     &
                                       NewTaggedDiagItem,             &
                                       metadataID=current%metadataID, &
                                       isWildcard=current%isWildcard, &
                                       tagName=current%tag,           &
                                       RC=RC)
             CALL InsertBeginning_TaggedDiagList( am_I_Root,         &
                                                  NewTaggedDiagItem, &
                                                  TaggedDiagList, RC )
          ENDIF
       ENDIF
       current => current%next
    ENDDO
    current => NULL()

    ! Optionally print
    CALL Print_TaggedDiagList( am_I_Root, TaggedDiagList, RC )

  END SUBROUTINE Init_TaggedDiagList
!EOC
!------------------------------------------------------------------------------
!                  GEOS-Chem Global Chemical Transport Model                  !
!------------------------------------------------------------------------------
!BOP
!
! !IROUTINE: Print_TaggedDiagList
!
! !DESCRIPTION: Subroutine Print\_TaggedDiagList prints information for all
!  TaggedDiagItem members in a TaggedDiagList linked list.
!\\
!\\
! !INTERFACE:
!
  SUBROUTINE Print_TaggedDiagList( am_I_Root, TaggedDiagList, RC )
!
! !INPUT PARAMETERS:
!
    LOGICAL,             INTENT(IN)    :: am_I_Root
    TYPE(TaggedDgnList), INTENT(IN)    :: TaggedDiagList
!
! !INPUT/OUTPUT PARAMETERS:
!
    INTEGER,             INTENT(INOUT) :: RC
!
! !REVISION HISTORY:
!  18 Nov 2019 - E. Lundgren - Initial version
!  See gitk browser for rest of revision history
!EOP
!------------------------------------------------------------------------------
!BOC
!
! !LOCAL VARIABLES:
!
    TYPE(TaggedDgnItem), POINTER :: current
    CHARACTER(LEN=255)           :: thisLoc

    ! ================================================================
    ! Print_TaggedDiagList begins here
    ! ================================================================
    thisLoc = 'Print_TaggedDiagList (taggeddiaglist_mod.F90)'
    current => TaggedDiagList%head

    IF ( am_I_Root ) THEN
       PRINT *, " "
       PRINT *, "============================="
       PRINT *, "Summary of tagged diagnostics"
       PRINT *, " "
    ENDIF
    DO WHILE ( ASSOCIATED( current ) )
       IF ( am_I_Root ) THEN
          PRINT *, TRIM(current%metadataID)
          PRINT *, "   isWildcard: ", current%isWildcard
          PRINT *, "   Wildcard list:"
          CALL Print_TagList(am_I_Root, current%wildcardList)
          PRINT *, "   Non-wildcard tag list:"
          CALL Print_TagList(am_I_Root, current%tagList)
          PRINT *, " "
       ENDIF
       current => current%next
    ENDDO
    current => NULL()
    IF ( am_I_Root ) PRINT *, " "

  END SUBROUTINE Print_TaggedDiagList
!EOC
!------------------------------------------------------------------------------
!                  GEOS-Chem Global Chemical Transport Model                  !
!------------------------------------------------------------------------------
!BOP
!
! !IROUTINE: Query_TaggedDiagList
!
! !DESCRIPTION: Return information about a TaggedDiagList option, such
!  if name is found and information about that named object. Info includes
!  if is wildcard, a list of wildcards, # of wildcards, a list of
!  non-wildcard tags, or # of non-wildcard tags.
!\\
!\\
! !INTERFACE:
!
  SUBROUTINE Query_TaggedDiagList ( am_I_Root, TaggedDiagList, name, &
                                    found, isWildcard, numWildcards, &
                                    numTags, wildcardList, tagList, RC )
!
! !USES:
!
    USE Charpak_Mod, ONLY : To_UpperCase
!
! !INPUT PARAMETERS:
!
    LOGICAL,             INTENT(IN) :: am_I_Root
    TYPE(TaggedDgnList), INTENT(IN) :: TaggedDiagList
    CHARACTER(LEN=*),    INTENT(IN) :: name
!
! !OUTPUT PARAMETERS:
!
    LOGICAL,             OPTIONAL   :: found
    LOGICAL,             OPTIONAL   :: isWildcard
    INTEGER,             OPTIONAL   :: numWildcards
    INTEGER,             OPTIONAL   :: numTags
    TYPE(TagList),       OPTIONAL   :: wildcardList
    TYPE(TagList),       OPTIONAL   :: tagList
    INTEGER,             OPTIONAL   :: RC
!
! !REVISION HISTORY:
!  18 Nov 2019 - E. Lundgren - Initial version
!  See gitk browser for rest of revision history
!EOP
!------------------------------------------------------------------------------
!BOC
!
! !LOCAL VARIABLES:
!
    TYPE(TaggedDgnItem), POINTER :: current
    CHARACTER(LEN=255)           :: thisLoc, thisDiagName

    ! Initialize
    thisLoc = 'Query_Name_in_TaggedDiagList (taggeddiaglist_mod.F90)'
    found = .FALSE.

    ! Search for name in list
    current => TaggedDiagList%head
    DO WHILE ( ASSOCIATED( current ) )
       thisDiagName = To_Uppercase(current%metadataID)
       IF ( TRIM(ThisDiagName) == TRIM(To_Uppercase(name)) ) THEN
          found = .TRUE.
          IF (PRESENT(isWildcard  )) isWildcard   = current%isWildcard
          IF (PRESENT(numWildcards)) numWildcards = current%wildcardList%count
          IF (PRESENT(numTags     )) numTags      = current%tagList%count
          IF (PRESENT(wildcardList)) wildcardList = current%wildcardList
          IF (PRESENT(tagList     )) tagList      = current%tagList
          current=> NULL()
          EXIT
       ENDIF
       current => current%next
    ENDDO
    current => NULL()

  END SUBROUTINE Query_TaggedDiagList
!EOC
!------------------------------------------------------------------------------
!                  GEOS-Chem Global Chemical Transport Model                  !
!------------------------------------------------------------------------------
!BOP
!
! !IROUTINE: Cleanup_TaggedDiagList
!
! !DESCRIPTION: Subroutine Cleanup\_TaggedDiagList deallocates a TaggedDiagList
!  object and all of its member objects including the linked list of
!  TaggedDiagItem objects.
!\\
!\\
! !INTERFACE:
!
  SUBROUTINE Cleanup_TaggedDiagList ( am_I_Root, TaggedDiagList, RC )
!
! !INPUT PARAMETERS:
!
    LOGICAL,             INTENT(IN)    :: am_I_Root
!
! !INPUT/OUTPUT PARAMETERS:
!
    TYPE(TaggedDgnList), INTENT(INOUT) :: TaggedDiagList
!
! !OUTPUT PARAMETERS:
!
    INTEGER,             INTENT(OUT)   :: RC
!
! !REVISION HISTORY:
!  18 Nov 2019 - E. Lundgren - Initial version
!  See gitk browser for rest of revision history
!EOP
!------------------------------------------------------------------------------
!BOC
!
! !LOCAL VARIABLES:
!
    TYPE(DgnItem), POINTER :: current
    TYPE(DgnItem), POINTER :: next
    CHARACTER(LEN=255)     :: thisLoc

    ! ================================================================
    ! Cleanup_TaggedDiagList begins here
    ! ================================================================
    thisLoc = 'Cleanup_TaggedDiagList (taggeddiaglist_mod.F90)'

    ! Deallocate each item in the linked list of DiagExport objects
    current => TaggedDiagList%head
    IF ( ASSOCIATED( current ) ) next => current%next
    DO WHILE ( ASSOCIATED( current ) )
       CALL cleanup_TagList(am_I_Root, current%taglist, RC)
       CALL cleanup_TagList(am_I_Root, current%wildcardlist, RC)
       DEALLOCATE( current, STAT=RC )
       IF ( RC /= GC_SUCCESS ) THEN
          PRINT *, "Error in ", trim(thisLoc)
          RETURN
       ENDIF
       IF ( .NOT. ASSOCIATED ( next ) ) EXIT
       current => next
       next => current%next
    ENDDO
    current => NULL()
    next    => NULL()

  END SUBROUTINE Cleanup_TaggedDiagList
!EOC
!------------------------------------------------------------------------------
!                  GEOS-Chem Global Chemical Transport Model                  !
!------------------------------------------------------------------------------
!BOP
!
! !IROUTINE: Init_TaggedDiagItem
!
! !DESCRIPTION: Initializes a taggedDiagItem object
!\\
!\\
! !INTERFACE:
!
  SUBROUTINE Init_TaggedDiagItem ( am_I_Root, NewTaggedDiagItem, metadataID, &
                                   isWildcard, tagName, RC  )
!
! !INPUT PARAMETERS:
!
    LOGICAL,             INTENT(IN) :: am_I_Root
    CHARACTER(LEN=*),    OPTIONAL   :: metadataID
    LOGICAL,             OPTIONAL   :: isWildcard
    CHARACTER(LEN=*),    OPTIONAL   :: tagName
!
! !OUTPUT PARAMETERS:
!
    TYPE(TaggedDgnItem), POINTER  :: NewTaggedDiagItem
    INTEGER,             OPTIONAL :: RC
!
! !REVISION HISTORY:
!  18 Nov 2019 - E. Lundgren - Initial version
!  See gitk browser for rest of revision history
!EOP
!------------------------------------------------------------------------------
!BOC
!
! !LOCAL VARIABLES:
!
    CHARACTER(LEN=255)     :: thisLoc
    TYPE(TagItem), POINTER :: NewTagItem

    ! ================================================================
    ! Init_TaggedDiagList begins here
    ! ================================================================
    thisLoc = 'Init_TaggedDiagItem (taggeddiaglist_mod.F90)'

    ALLOCATE(NewTaggedDiagItem)
    NewTaggedDiagItem%metadataID = ''
    NewTaggedDiagItem%isWildcard = .FALSE.

    ! Initialize wildcard list
    NewTaggedDiagItem%wildcardList%head => NULL()
    NewTaggedDiagItem%wildcardList%count 0

    ! Initialize non-wildcard list of tags
    NewTaggedDiagItem%tagList%head => NULL()
    NewTaggedDiagItem%tagList%count = 0

    ! Set true values if passed
    IF (PRESENT(metadataID) ) NewTaggedDiagItem%metadataID = TRIM(metadataID)
    IF (PRESENT(isWildcard) ) NewTaggedDiagItem%isWildcard = isWildcard
    IF (PRESENT(tagName) ) THEN
       CALL Init_TagItem( am_I_Root, NewTagItem, tagName, RC )
       IF ( isWildcard ) THEN
          CALL InsertBeginning_TagList( am_I_Root, NewTagItem, &
                                        NewTaggedDiagItem%wildcardList, RC )
       ELSE
          CALL InsertBeginning_TagList( am_I_Root, NewTagItem, &
                                        NewTaggedDiagItem%tagList, RC )
       ENDIF
    ENDIF
  END SUBROUTINE Init_TaggedDiagItem
!EOC
!------------------------------------------------------------------------------
!                  GEOS-Chem Global Chemical Transport Model                  !
!------------------------------------------------------------------------------
!BOP
!
! !IROUTINE: Init_TagItem
!
! !DESCRIPTION: Initializes a TagItem object, which contains information
!  about a single GEOS-Chem diagnostic tag.
!\\
!\\
! !INTERFACE:
!
  SUBROUTINE Init_TagItem ( am_I_Root, NewTagItem, name, RC  )
!
! !INPUT PARAMETERS:
!
    LOGICAL,       INTENT(IN) :: am_I_Root
    TYPE(TagItem), POINTER    :: NewTagItem
    CHARACTER(LEN=*)          :: name
!
! !OUTPUT PARAMETERS:
!
    INTEGER,       OPTIONAL   :: RC
!
! !REVISION HISTORY:
!  18 Nov 2019 - E. Lundgren - Initial version
!  See gitk browser for rest of revision history
!EOP
!------------------------------------------------------------------------------
!BOC
!
! !LOCAL VARIABLES:
!
    CHARACTER(LEN=255) :: thisLoc

    ! ================================================================
    ! Init_TagItem begins here
    ! ================================================================
    thisLoc = 'Init_TagItem (taggeddiaglist_mod.F90)'

    ALLOCATE(NewTagItem)
    NewTagItem%name      = TRIM(name)

  END SUBROUTINE Init_TagItem
!EOC
!------------------------------------------------------------------------------
!                  GEOS-Chem Global Chemical Transport Model                  !
!------------------------------------------------------------------------------
!BOP
!
! !IROUTINE: InsertBeginning_TaggedDiagList
!
! !DESCRIPTION: Inserts a new node at the beginning of the TaggedDiagList linked
!  list object.
!\\
!\\
! !INTERFACE:
!
  SUBROUTINE InsertBeginning_TaggedDiagList ( am_I_Root, TaggedDiagItem, &
                                              TaggedDiagList, RC )
!
! !USES:
!
!
! !INPUT PARAMETERS:
!
    LOGICAL,             INTENT(IN)    :: am_I_Root
    TYPE(TaggedDgnItem), POINTER       :: TaggedDiagItem
!
! !INPUT/OUTPUT PARAMETERS:
!
    TYPE(TaggedDgnList), INTENT(INOUT) :: TaggedDiagList
!
! !OUTPUT PARAMETERS:
!
    INTEGER,             INTENT(OUT)   :: RC
!
! !REVISION HISTORY:
!  18 Nov 2019 - E. Lundgren - initial version
!  See gitk browser for rest of revision history
!EOP
!------------------------------------------------------------------------------
!BOC
!
! !LOCAL VARIABLES:
!
    TYPE(TaggedDgnItem), POINTER :: NewTaggedDiagItem
    CHARACTER(LEN=255)           :: thisLoc

    ! ================================================================
    ! InsertBeginning_TaggedDiagList begins here
    ! ================================================================
    thisLoc = 'InsertBeginning_TaggedDiagList (taggeddiaglist_mod.F90)'

    ! Add new object to the beginning of the linked list
    TaggedDiagItem%next => TaggedDiagList%head
    TaggedDiagList%head => TaggedDiagItem

  END SUBROUTINE InsertBeginning_TaggedDiagList
!EOC
!EOC
!------------------------------------------------------------------------------
!                  GEOS-Chem Global Chemical Transport Model                  !
!------------------------------------------------------------------------------
!BOP
!
! !IROUTINE: InsertBeginning_TagList
!
! !DESCRIPTION: Inserts a new node at the beginning of the TagList linked
!  list object.
!\\
!\\
! !INTERFACE:
!
  SUBROUTINE InsertBeginning_TagList ( am_I_Root, TagItem, TagList, RC )
!
! !INPUT PARAMETERS:
!
    LOGICAL,         INTENT(IN)    :: am_I_Root
    TYPE(TagItem),   POINTER       :: TagItem
!
! !INPUT/OUTPUT PARAMETERS:
!
    TYPE(TagList),   INTENT(INOUT) :: TagList
!
! !OUTPUT PARAMETERS:
!
    INTEGER,         INTENT(OUT)   :: RC
!
! !REVISION HISTORY:
!  18 Nov 2019 - E. Lundgren - initial version
!  See gitk browser for rest of revision history
!EOP
!------------------------------------------------------------------------------
!BOC
!
! !LOCAL VARIABLES:
!
    TYPE(TagItem),  POINTER :: NewTaglItem
    CHARACTER(LEN=255)      :: thisLoc

    ! ================================================================
    ! InsertBeginning_TagList begins here
    ! ================================================================
    thisLoc = 'InsertBeginning_TagList (taggeddiaglist_mod.F90)'

    ! Add new object to the beginning of the linked list
    TagItem%next => TaglList%head
    TagList%head => TaglItem
    TagList%count = TagList%count + 1

  END SUBROUTINE InsertBeginning_TagList
!EOC
!------------------------------------------------------------------------------
!                  GEOS-Chem Global Chemical Transport Model                  !
!------------------------------------------------------------------------------
!BOP
!
! !IROUTINE: Query_Tag_in_TagList
!
! !DESCRIPTION: Searches for a given tag name within TagList object.
!\\
!\\
! !INTERFACE:
!
  SUBROUTINE Query_Tag_in_TaggList( am_I_Root, TagList, name, found, RC )
!
! !USES:
!
    USE Charpak_Mod, ONLY : To_UpperCase
!
!
! !INPUT PARAMETERS:
!
    LOGICAL,           INTENT(IN)  :: am_I_Root
    TYPE(TagList),     INTENT(IN)  :: TagList
    CHARACTER(LEN=*),  INTENT(IN)  :: name
!
! !OUTPUT PARAMETERS:
!
    LOGICAL,           INTENT(OUT) :: found
    INTEGER,           INTENT(OUT) :: RC
!
! !REVISION HISTORY:
!  18 Nov 2019 - E. Lundgren - Initial version
!  See gitk browser for rest of revision history
!EOP
!------------------------------------------------------------------------------
!BOC
!
! !LOCAL VARIABLES:
!
    TYPE(TagItem), POINTER :: current
    CHARACTER(LEN=255)     :: thisLoc, thisTagName

    ! Initialize
    thisLoc = 'Query_Tag_in_TagList (taggeddiaglist_mod.F90)'
    found = .FALSE.

    ! Search for name in list
    current => TagList%head
    DO WHILE ( ASSOCIATED( current ) )
       thisTagName = To_Uppercase(current%name)
       IF ( TRIM(thisTagName) == TRIM(To_Uppercase(name)) ) THEN
          found = .TRUE.
          EXIT
       ENDIF
       current => current%next
    ENDDO
    current => NULL()

  END SUBROUTINE Query_Tag_in_TagList
!EOC
!------------------------------------------------------------------------------
!                  GEOS-Chem Global Chemical Transport Model                  !
!------------------------------------------------------------------------------
!BOP
!
! !IROUTINE: Print_TagList
!
! !DESCRIPTION: Subroutine Print\_TagList prints information for all
!  TagItem members in a TagList linked list.
!\\
!\\
! !INTERFACE:
!
  SUBROUTINE Print_TagList( am_I_Root, TagList, RC )
!
! !INPUT PARAMETERS:
!
    LOGICAL,           INTENT(IN)    :: am_I_Root
    TYPE(TagList),     INTENT(IN)    :: TagList
!
! !INPUT/OUTPUT PARAMETERS:
!
    INTEGER,           INTENT(INOUT) :: RC
!
! !REVISION HISTORY:
!  18 Nov 2019 - E. Lundgren - Initial version
!  See gitk browser for rest of revision history
!EOP
!------------------------------------------------------------------------------
!BOC
!
! !LOCAL VARIABLES:
!
    TYPE(TagItem), POINTER :: current
    CHARACTER(LEN=255)     :: thisLoc

    ! ================================================================
    ! Print_TagList begins here
    ! ================================================================
    thisLoc = 'Print_TagList (taggeddiaglist_mod.F90)'
    current => TagList%head

    IF ( am_I_Root ) THEN
       PRINT *, "--> Size of tag list: ", TagList%count
    ENDIF
    DO WHILE ( ASSOCIATED( current ) )
       IF ( am_I_Root ) THEN
          PRINT *, "--> ", TRIM(current%name)
       ENDIF
       current => current%next
    ENDDO
    current => NULL()

  END SUBROUTINE Print_TagList
!EOC
!------------------------------------------------------------------------------
!                  GEOS-Chem Global Chemical Transport Model                  !
!------------------------------------------------------------------------------
!BOP
!
! !IROUTINE: Update_TaggedDiagList
!
! !DESCRIPTION: Update the taggedDiagList object with new information about
!  an item
!\\
!\\
! !INTERFACE:
!
  SUBROUTINE Update_TaggedDiagList ( am_I_Root, TaggedDiagList, metadataID, &
                                     isWildcard, tagName, RC  )
!
! !INPUT PARAMETERS:
!
    LOGICAL,             INTENT(IN)  :: am_I_Root
    CHARACTER(LEN=*),    INTENT(IN)  :: metadataID
    LOGICAL,             INTENT(IN)  :: isWildcard
    CHARACTER(LEN=*),    INTENT(IN)  :: tagName
!
! !INPUT/OUTPUT PARAMETERS:
!
    TYPE(TaggedDgnList), POINTER     :: TaggedDiagList
!
! !OUTPUT PARAMETERS:
!
    INTEGER,             INTENT(OUT) :: RC
!
! !REVISION HISTORY:
!  18 Nov 2019 - E. Lundgren - Initial version
!  See gitk browser for rest of revision history
!EOP
!------------------------------------------------------------------------------
!BOC
!
! !LOCAL VARIABLES:
!
    TYPE(TaggedDgnItem), POINTER :: current
    TYPE(TagItem),       POINTER :: NewTagItem
    CHARACTER(LEN=255)           :: thisLoc, thisDiagName

    ! ================================================================
    ! Update_TaggedDiagList begins here
    ! ================================================================
    thisLoc = 'Update_TaggedDiagItem (taggeddiaglist_mod.F90)'

    ! Search for item in list
    current => TaggedDiagList%head
    DO WHILE ( ASSOCIATED( current ) )
       thisDiagName = To_Uppercase(current%metadataID)
       IF ( TRIM(ThisDiagName) == TRIM(To_Uppercase(name)) ) THEN
          CALL Init_TagItem( am_I_Root, NewTagItem, tagName, RC )
          IF ( isWildcard ) THEN
             current%isWildcard = .TRUE.
             CALL InsertBeginning_TagList( am_I_Root, NewTagItem, &
                                           NewTaggedDiagItem%wildcardList, RC )
          ELSE
             CALL InsertBeginning_TagList( am_I_Root, NewTagItem, &
                                           NewTaggedDiagItem%tagList, RC )
          ENDIF
       ENDIF
       current => current%next
    ENDDO
    current => NULL()

  END SUBROUTINE Update_TaggedDiagList
!EOC
!------------------------------------------------------------------------------
!                  GEOS-Chem Global Chemical Transport Model                  !
!------------------------------------------------------------------------------
!BOP
!
! !IROUTINE: Cleanup_TagList
!
! !DESCRIPTION: Subroutine Cleanup\_TagList deallocates a TagList object
!  and all of its member objects including the linked list of TagItem objects.
!\\
!\\
! !INTERFACE:
!
  SUBROUTINE Cleanup_TagList ( am_I_Root, TagList, RC )
!
! !INPUT PARAMETERS:
!
    LOGICAL,           INTENT(IN)    :: am_I_Root
!
! !INPUT/OUTPUT PARAMETERS:
!
    TYPE(TagList),     INTENT(INOUT) :: TagList
!
! !OUTPUT PARAMETERS:
!
    INTEGER,           INTENT(OUT)   :: RC
!
! !REVISION HISTORY:
!  18 Sep 2019 - E. Lundgren - Initial version
!  See gitk browser for rest of revision history
!EOP
!------------------------------------------------------------------------------
!BOC
!
! !LOCAL VARIABLES:
!
    TYPE(TagItem), POINTER :: current
    TYPE(TagItem), POINTER :: next
    CHARACTER(LEN=255)     :: thisLoc

    ! ================================================================
    ! Cleanup_TagList begins here
    ! ================================================================
    thisLoc = 'Cleanup_TagList (taggeddiaglist_mod.F90)'

    ! Deallocate each item in the linked list of collection objects
    current => TaglList%head
    IF ( ASSOCIATED( current ) ) next => current%next
    DO WHILE ( ASSOCIATED( current ) )
       DEALLOCATE( current, STAT=RC )
       IF ( RC /= GC_SUCCESS ) THEN
          PRINT *, "Error in ", trim(thisLoc)
          RETURN
       ENDIF
       IF ( .NOT. ASSOCIATED ( next ) ) EXIT
       current => next
       next => current%next
    ENDDO
    current => NULL()
    next    => NULL()

  END SUBROUTINE Cleanup_TagList
!EOC
END MODULE TaggedDiagList_Mod
